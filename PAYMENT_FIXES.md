# Исправление проблемы с потерей платежей

## Проблема

Иногда пользователь оплачивал тариф, но система не подтверждала платёж и не выдавала ключ. В итоге деньги списывались, а доступ не появлялся.

## Решение

Реализован механизм, который гарантирует:
- ✅ Реальные платежи не теряются
- ✅ Пользователь всегда понимает, что происходит
- ✅ Ключ не может быть выдан дважды

## Изменения

### 1. Добавлено поле `key_issued_at` в модель `PaymentsOrm`

Поле отслеживает, был ли уже выдан ключ для платежа. Это позволяет:
- Проверять идемпотентность обработки платежей
- Восстанавливать платежи, для которых ключ не был выдан

### 2. Идемпотентная обработка платежей

Функция `process_success_payment` теперь:
- Проверяет, был ли уже выдан ключ перед обработкой
- Безопасна для повторных вызовов
- Помечает платеж как обработанный только после успешной выдачи ключа

### 3. Механизм восстановления

Добавлена функция `check_success_payments_without_key`, которая:
- Запускается каждые 60 секунд
- Находит все платежи в статусе `success` без выданного ключа
- Автоматически обрабатывает их повторно

### 4. Улучшенная обработка ошибок

- Добавлено логирование всех ошибок
- Уведомления администраторам при критических ошибках
- Платежи не теряются при временных сбоях

## Миграция базы данных

Для применения изменений к существующей базе данных выполните SQL-скрипт:

```bash
psql -U postgres -d your_database_name -f migrations/add_key_issued_at.sql
```

Или выполните SQL вручную:

```sql
ALTER TABLE payments 
ADD COLUMN IF NOT EXISTS key_issued_at TIMESTAMP WITH TIME ZONE NULL;

CREATE INDEX IF NOT EXISTS idx_payments_success_without_key 
ON payments(status, key_issued_at) 
WHERE status = 'success' AND key_issued_at IS NULL;
```

## Как это работает

### Обычный поток обработки платежа:

1. Пользователь оплачивает тариф → создается платеж со статусом `pending`
2. Планировщик каждые 25 секунд проверяет pending платежи
3. При обнаружении успешного платежа:
   - Платеж помечается как `success`
   - Вызывается `process_success_payment`
   - Выдается ключ
   - Платеж помечается как обработанный (`key_issued_at` устанавливается)

### Восстановление при ошибке:

1. Если при выдаче ключа произошла ошибка:
   - Платеж остается в статусе `success`
   - `key_issued_at` остается `NULL`
2. Планировщик восстановления каждые 60 секунд:
   - Находит такие платежи
   - Повторно пытается выдать ключ
   - При успехе помечает платеж как обработанный

### Защита от двойной выдачи:

- Функция `process_success_payment` проверяет `key_issued_at` перед обработкой
- Если ключ уже выдан, обработка пропускается
- Это гарантирует, что один платеж не обработается дважды

## Новые функции в `src/database/crud/payments.py`

- `mark_key_issued(payment_id)` - помечает платеж как обработанный
- `is_key_issued(payment)` - проверяет, был ли выдан ключ
- `get_success_payments_without_key()` - получает платежи для восстановления

## Логирование

Все операции логируются с уровнем:
- `INFO` - успешные операции
- `WARNING` - обнаружены платежи для восстановления
- `ERROR` - ошибки обработки

## Тестирование

После применения миграции проверьте:
1. Новые платежи обрабатываются корректно
2. Старые платежи в статусе `success` без ключа восстанавливаются
3. Повторная обработка одного платежа не приводит к двойной выдаче ключа

