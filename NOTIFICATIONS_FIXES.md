# Исправления системы уведомлений

## Выполненные исправления

### 1. Устранены несоответствия в обработке временных зон
- ✅ Переименована функция `_ensure_utc` → `_ensure_msk` для ясности
- ✅ Все расчеты времени выполняются в московском времени (Europe/Moscow)
- ✅ В БД значения хранятся как TIMESTAMPTZ (автоматически конвертируются в UTC)
- ✅ При сравнении в БД используется UTC для корректной работы
- ✅ Добавлены подробные комментарии о работе с временными зонами

### 2. Исправлена логика расчета offset
- ✅ Для напоминаний (expiring_soon): отправка ДО события (finish - offset)
- ✅ Для уведомлений об окончании (expired): отправка ПОСЛЕ события (finish + offset)
- ✅ Если запланированное время в прошлом, отправка происходит сразу
- ✅ Улучшена обработка edge cases (ключ уже истек и т.д.)

### 3. Улучшена документация и комментарии
- ✅ Добавлена подробная документация в начале `notifications.py`
- ✅ Добавлены описания типов уведомлений для админов
- ✅ Улучшено форматирование правил в админ-панели
- ✅ Добавлены docstrings для всех ключевых функций

### 4. Оптимизирована логика отправки уведомлений
- ✅ Добавлена защита от бесконечного цикла (max_batches)
- ✅ Улучшена обработка ошибок при отправке
- ✅ Добавлен запуск отправки при старте сервиса
- ✅ Настроены параметры планировщика (max_instances, misfire_grace_time)
- ✅ Улучшено логирование для отладки

### 5. Упрощена логика работы с ключами
- ✅ Уточнена роль функций `on_trial_key_created`, `on_paid_key_created`
- ✅ Добавлены комментарии о том, что расписания создаются через `sync_user_key_rules`
- ✅ Улучшена обработка повторов уведомлений

## Как работает система уведомлений

### Типы уведомлений

**A) trial_expiring_soon** - Напоминание о скором окончании пробного ключа
- Отправляется ДО окончания ключа (за указанное время)
- Может повторяться, если у пользователя нет платного ключа

**B) trial_expired** - Уведомление об окончании пробного ключа
- Отправляется в момент окончания или после (с задержкой, если указана)
- Может повторяться, если у пользователя нет платного ключа

**C) paid_expiring_soon** - Напоминание о скором окончании платного ключа
- Отправляется ДО окончания ключа (за указанное время)
- Может повторяться, если у пользователя нет активного платного ключа

**D) paid_expired** - Уведомление об окончании платного ключа
- Отправляется в момент окончания или после (с задержкой, если указана)
- Может повторяться, если у пользователя нет активного платного ключа

**E) new_user_no_keys** - Уведомление для пользователей без ключей
- Отправляется сразу после регистрации или через указанное время
- Может повторяться, если у пользователя все еще нет активных ключей

**F) global_weekly** - Глобальная еженедельная рассылка
- Отправляется в указанный день недели и время
- Использует таймзону из настроек правила (по умолчанию Europe/Moscow)

### Временные зоны

- **Все расчеты**: московское время (Europe/Moscow)
- **Хранение в БД**: TIMESTAMPTZ (автоматически конвертируется в UTC)
- **Сравнение в БД**: UTC (PostgreSQL автоматически конвертирует)

### Автоматическое планирование

1. **При создании/обновлении ключа**:
   - Автоматически создаются расписания для правил A-D
   - Отменяются уведомления, которые больше не актуальны

2. **При создании/обновлении правила**:
   - Автоматически создаются расписания для всех подходящих пользователей
   - При деактивации правила отменяются все запланированные уведомления

3. **При отправке уведомления**:
   - Если правило имеет интервал повтора и пользователь подходит под условия - планируется следующее уведомление

### Отправка уведомлений

- **Проверка готовых уведомлений**: каждые 60 секунд
- **Обработка**: батчами по 50 штук
- **Защита**: максимум 100 батчей за раз (5000 уведомлений)
- **При старте**: сразу отправляются готовые уведомления

## Для админов

### Создание правила уведомления

1. Выберите тип уведомления (A-F)
2. Введите название правила
3. Для типов A-E:
   - Укажите задержку отправки (для напоминаний - за сколько ДО окончания)
   - Укажите интервал повтора (или 0 для отключения)
4. Для типа F:
   - Выберите день недели
   - Укажите время отправки
   - Укажите таймзону (по умолчанию Europe/Moscow)
5. Отправьте шаблон сообщения (текст, фото, видео или документ)
6. При необходимости добавьте inline-кнопки

### Редактирование правила

- Можно изменить шаблон сообщения
- Можно изменить задержку отправки
- Можно изменить интервал повтора
- Можно включить/отключить правило
- Можно удалить правило

### Просмотр правила

При просмотре правила отображается:
- Тип и название
- Статус (активно/отключено)
- Расписание или смещение времени отправки
- Интервал повтора
- Описание типа уведомления

## Важные замечания

1. **Время отправки**: Все времена указываются и отображаются в московском времени (MSK)
2. **Повтор уведомлений**: Работает только если пользователь все еще подходит под условия правила
3. **Глобальные рассылки**: Используют таймзону из настроек правила (по умолчанию Europe/Moscow)
4. **Автоматическое планирование**: При изменении ключа или правила расписания пересчитываются автоматически




